rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    // Each user can only read/write their own document
    // Path: /users/{uid}
    
    match /users/{uid} {
      function isOwner() {
        return request.auth != null && request.auth.uid == uid;
      }

      // Ensure the stored uid matches the document path uid (basic integrity)
      function hasMatchingUid() {
        return request.resource.data.uid == uid;
      }

      // Reads: owner only
      allow read: if isOwner();

      // Creates: owner only + uid must match
      allow create: if isOwner() && hasMatchingUid();

      // Updates: owner only + uid must remain correct
      allow update: if isOwner() && hasMatchingUid() && resource.data.uid == uid;

      // Deletes: owner only
      allow delete: if isOwner();
      
      // ----------------------------------------
      // TRACKS SUBCOLLECTION
      // ----------------------------------------
      // User's saved tracks: /users/{uid}/tracks/{trackId}
      match /tracks/{trackId} {
        allow read, write: if isOwner();
      }
      
      // ----------------------------------------
      // SETTINGS SUBCOLLECTION
      // ----------------------------------------
      // User preferences: /users/{uid}/settings/{settingId}
      match /settings/{settingId} {
        allow read, write: if isOwner();
      }
      
      // ----------------------------------------
      // ANY OTHER SUBCOLLECTIONS
      // ----------------------------------------
      // Catch-all for any future subcollections under the user document
      match /{subcollection}/{docId} {
        allow read, write: if isOwner();
      }
    }
    
    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================
    // Any path not explicitly matched above is denied by default
    // This is the default Firestore behavior, but making it explicit
    
  }
}

