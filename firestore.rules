rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    // Each user can only read/write their own document
    // Path: /users/{uid}
    
    match /users/{uid} {
      function isOwner() {
        return request.auth != null && request.auth.uid == uid;
      }

      // Ensure the stored uid matches the document path uid (basic integrity)
      function hasMatchingUid() {
        return request.resource.data.uid == uid;
      }

      // Validate user profile schema
      function isValidProfile() {
        let data = request.resource.data;
        return data.keys().hasAll(['uid', 'email', 'character']) &&
               data.uid is string &&
               (data.email == null || data.email is string) &&
               (data.displayName == null || (data.displayName is string && data.displayName.size() <= 50)) &&
               (data.photoURL == null || data.photoURL is string) &&
               data.character in ['ball', 'snowboarder', 'skateboarder', 'horse'];
      }

      // Reads: owner only
      allow read: if isOwner();

      // Creates: owner only + uid must match + valid schema
      allow create: if isOwner() && hasMatchingUid() && isValidProfile();

      // Updates: owner only + uid must remain correct + valid schema
      allow update: if isOwner() && hasMatchingUid() && resource.data.uid == uid && isValidProfile();

      // Deletes: owner only
      allow delete: if isOwner();
      
      // ----------------------------------------
      // TRACKS SUBCOLLECTION
      // ----------------------------------------
      // User's saved tracks: /users/{uid}/tracks/{trackId}
      match /tracks/{trackId} {
        function isValidTrack() {
          let data = request.resource.data;
          return data.keys().hasAll(['name']) &&
                 data.name is string &&
                 data.name.size() <= 100;
        }

        allow read: if isOwner();
        allow create: if isOwner() && isValidTrack();
        allow update: if isOwner() && isValidTrack();
        allow delete: if isOwner();
      }
      
      // ----------------------------------------
      // SETTINGS SUBCOLLECTION
      // ----------------------------------------
      // User preferences: /users/{uid}/settings/{settingId}
      match /settings/{settingId} {
        allow read: if isOwner();
        allow write: if isOwner()
                     && request.resource.data.keys().size() <= 20;
      }
    }
    
    // ============================================
    // DENY ALL OTHER ACCESS
    // ============================================
    // Any path not explicitly matched above is denied by default
    // This is the default Firestore behavior, but making it explicit
    
  }
}
